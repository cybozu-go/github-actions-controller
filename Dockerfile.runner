FROM quay.io/cybozu/golang:1.16-focal as builder

WORKDIR /workspace
COPY . .
RUN make build-agent build-annotator

FROM quay.io/cybozu/ubuntu:20.04

ARG RUNNER_VERSION=2.277.1
ARG DUMB_INIT_VERSION=1.2.2

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update -y \
  && apt-get install -y software-properties-common \
  && add-apt-repository -y ppa:git-core/ppa \
  && apt-get update -y \
  && apt-get install -y --no-install-recommends libyaml-dev \
  && rm -rf /var/lib/apt/lists/*

RUN curl -sSLf -o /usr/local/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v${DUMB_INIT_VERSION}/dumb-init_${DUMB_INIT_VERSION}_amd64 \
  && chmod +x /usr/local/bin/dumb-init

ARG RUNNER_ASSETS_DIR=/runner
RUN mkdir -p ${RUNNER_ASSETS_DIR} \
  && cd ${RUNNER_ASSETS_DIR} \
  && curl -L -O https://raw.githubusercontent.com/actions/runner/${RUNNER_VERSION}/LICENSE \
  && curl -L -o runner.tar.gz https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz \
  && tar xzf ./runner.tar.gz \
  && rm runner.tar.gz \
  && ./bin/installdependencies.sh \
  && rm ./bin/RunnerService.js \
  && chown -R 10000 ${RUNNER_ASSETS_DIR}

ENV AGENT_TOOLSDIRECTORY=/opt/hostedtoolcache
RUN mkdir -p ${AGENT_TOOLSDIRECTORY} \
  && chmod g+rwx ${AGENT_TOOLSDIRECTORY}

USER 10000
COPY scripts/entrypoint.sh /usr/local/bin/
COPY scripts/job-failed /usr/local/bin/
COPY scripts/job-started /usr/local/bin/
COPY scripts/RunnerService.js ${RUNNER_ASSETS_DIR}/bin/

COPY --from=builder /workspace/bin/slack-agent /usr/local/bin
COPY --from=builder /workspace/bin/deltime-annotate /usr/local/bin

ENTRYPOINT ["/usr/local/bin/dumb-init", "--"]
CMD ["/usr/local/bin/entrypoint.sh"]
